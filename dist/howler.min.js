!function(e,t,o){"use strict";function r(){this.sounds=new p.Map}function n(e,t){return e.off("stop",t),e.off("end",t),p.q.resolve(!0)}function s(e){a.call(this,e),r.call(this)}function i(){return null}function l(e,t){return e+"/"+t}function u(e){a.call(this,e),r.call(this)}function d(e,t){if(t&&!p.isString(t))throw new Error("Unable to play sound sprites upon something that is not a string: "+t);this.sound=e,this.sprite=t||void 0,this._cnt=null,this._onend=this._onEnd.bind(this),this.reps=0,this.defer=null,this._time=null}var p=ALLEX.lib,a=o.BasicResourceLoader,h=(o.getResource,p.q),c={type:"object",properties:{sounds:{type:"array",items:{type:"object",properties:{name:{type:"string"},baseURL:{type:"string"},files:{type:"array",items:{type:"string"},volume:{type:"number",min:0,max:1},minItems:1},sprite:{type:"object"}},required:["files","name"]},minItems:1},baseURL:{type:"string"},volume:{type:"number"},ispermanent:{type:"boolean"}},additionalProperties:!1},f={type:"object",properties:{main_resource:{type:"string"},override_resource:{type:"string"}}};r.prototype.destroy=function(){this.sounds.destroy(),this.sounds=null},r.prototype.traverse=function(e){this.sounds.traverse(e)},r.prototype.getSound=function(e){return this.sounds.get(e)},r.prototype.start=function(e,t,o){var r=this.getSound(e),s=p.q.defer(),i=s.resolve.bind(s,!0);return r?(r.stop(),r.on("stop",i),r.on("end",i),console.log("will play ",e,t,o),r.play(o),s.promise.then(n.bind(null,r,i))):t?s.resolve(!0):s.reject(new Error("No sound "+e))},r.prototype.muteAllSounds=Howler.mute.bind(Howler),r.prototype.stopResourceSounds=function(){this.sounds.traverse(p.doMethod.bind(null,"stop",null))},r.prototype.loopSound=function(e,t){var o=this.getSound(e);if(!o)throw new Error("No sound registered: "+e);return new d(o,t)},r.addMethods=function(e){p.inheritMethods(e,r,"getSound","start","muteAllSounds","stopResourceSounds","loopSound","traverse")},p.inherit(s,a),r.addMethods(s),s.prototype.__cleanUp=function(){r.prototype.destroy.call(this),a.prototype.__cleanUp.call(this)},s.prototype.doLoad=function(){var e={baseURL:this.getConfigVal("baseURL"),volume:this.getConfigVal("volume")},t=p.q.defer(),o=this.getConfigVal("sounds").map(i),r=p.q.all(this.getConfigVal("sounds").map(this._loadASound.bind(this,e,t,o)));return p.qlib.promise2defer(r,t),t},s.prototype.doUnload=function(){return this.sounds.traverse(this._unloadSound.bind(this)),this.sounds.purge(),h.resolve(!0)},s.prototype._unloadSound=function(e,t){e&&(e.stop(),e.unload())},s.prototype._notifyMainDefer=function(e,t,o,r){r[o]=!0;var n=r.filter(p.isVal),s={type:"howler",percent:Math.floor(100*n.length/r.length)};e.notify(s),t.resolve(!0)},s.prototype._loadASound=function(e,t,o,r,n){var s=p.q.defer(),i=p.extend({},e,r),u=new Howl({src:i.files.map(l.bind(null,i.baseURL)),autoplay:!1,volume:"volume"in i?i.volume:1,loop:i.loop||!1,sprite:i.sprite||void 0,preload:!0,mute:!1,onload:this._notifyMainDefer.bind(this,t,s,n,o),onloaderror:this._failed.bind(this,s,i),html5:i.html5||!1});return this.sounds.add(i.name,u),s.promise},s.prototype._failed=function(e){console.log("failed to load",arguments),console.trace(),e.reject(new Error("failed"))},s.prototype.CONFIG_SCHEMA=function(){return c},s.prototype.DEFAULT_CONFIG=function(){return null},p.inherit(u,a),r.addMethods(u),u.prototype.__cleanUp=function(){r.prototype.destroy.call(this),a.prototype.__cleanUp.call(this)},u.prototype._add_sound=function(e,t){this.sounds.add(t,e)},u.prototype._replace_sound=function(e,t){this.sounds.replace(t,e)},u.prototype.merge=function(e,t){return e&&e.traverse(this._add_sound.bind(this)),t&&t.traverse(this._replace_sound.bind(this)),h.resolve(!0)},u.prototype._resolveResource=function(e){var t=this.getConfigVal(e);return p.isString(t)?a.getResourceFromName(t):t},u.prototype.doLoad=function(){var e=this._doLoad(),t=h.defer();return p.qlib.promise2defer(e,t),t},u.prototype._doLoad=function(){var e=this._resolveResource("main_resource"),t=this._resolveResource("override_resource");return e||t?e?t?h.all([e.doLoad(),t.doLoad()]).then(this.merge.bind(this,e,t)):e.doLoad().then(this.merge.bind(this,e)):t.doLoad().then(this.merge.bind(this,null,t)):h.resolve(!0)},u.prototype.doUnload=function(){var e=this._doUnload(),t=h.defer();return p.qlib.promise2defer(e,t),t},u.prototype._doUnload=function(){this.sounds.purge();var e=this._resolveResource("main_resource"),t=this._resolveResource("override_resource");return e||t?e?t?h.all([this._resolveResource("main_resource").doUnload(),this._resolveResource("override_resource").doUnload()]):e.doUnload():t.doUnload():h.resolve(!0)},u.prototype.CONFIG_SCHEMA=function(){return f},u.prototype.DEFAULT_CONFIG=function(){return null},d.prototype.destroy=function(){this.sound=null,this.sprite=null,this._cnt=null,this._onend=null,this.reps=null,this.defer=null,this._time=null},d.prototype.stop=function(){this.defer&&this.defer.resolve(!0),this.sound.off("end",this._onend),this.sound.stop(),this.reps=0},d.prototype.start=function(e,t){return this._time=(new Date).getTime(),t||(t=p.q.defer()),this.reps=p.isNumber(e)&&e>0?e:null,this.defer=t,this.sound.on("end",this._onend),this._onEnd(),t.promise},d.prototype._onEnd=function(){this._time;if(this._time=(new Date).getTime(),p.isNull(this.reps))this.defer.notify({remaining:1/0});else{if(!this.reps)return void this.stop();this.defer.notify({remaining:this.reps}),this.reps--}this.sound.play(this.sprite)},t.resources.HowlerResource=s,o.registerResourceType("Howler",s),o.registerResourceType("HowlerMerger",u)}(0,ALLEX.WEB_COMPONENTS.allex_web_webappcomponent,ALLEX.WEB_COMPONENTS.allex_applib);