!function(e,t,o){"use strict";function r(){this.sounds=new d.Map}function n(e){l.call(this,e),r.call(this)}function s(){return null}function i(e){l.call(this,e),r.call(this)}function u(e,t){if(t&&!d.isString(t))throw new Error("Unable to play sound sprites upon something that is not a string: "+t);this.sound=e,this.sprite=t||void 0,this._cnt=null,this._onend=this._onEnd.bind(this),this.reps=0,this.defer=null,this._time=null}var d=e.lib,l=o.BasicResourceLoader,p=(o.getResource,d.q),a={type:"object",properties:{sounds:{type:"array",items:{type:"object",properties:{name:{type:"string"},baseURL:{type:"string"},files:{type:"array",items:{type:"string"},volume:{type:"number",min:0,max:1},minItems:1},sprite:{type:"object"}},required:["files","name"]},minItems:1},baseURL:{type:"string"},volume:{type:"number"},ispermanent:{type:"boolean"}},additionalProperties:!1},h={type:"object",properties:{main_resource:{type:"string"},override_resource:{type:"string"}}};r.prototype.destroy=function(){this.sounds.destroy(),this.sounds=null},r.prototype.traverse=function(e){this.sounds.traverse(e)},r.prototype.getSound=function(e){return this.sounds.get(e)},r.prototype.start=function(e,t,o){var r=this.getSound(e),n=d.q.defer(),s=n.resolve.bind(n,!0);return r?(r.stop(),r.on("stop",s),r.on("end",s),console.log("will play ",e,t,o),r.play(o),n.promise.then(function(e,t){return e.off("stop",t),e.off("end",t),d.q.resolve(!0)}.bind(null,r,s))):t?n.resolve(!0):n.reject(new Error("No sound "+e))},r.prototype.muteAllSounds=Howler.mute.bind(Howler),r.prototype.stopResourceSounds=function(){this.sounds.traverse(d.doMethod.bind(null,"stop",null))},r.prototype.loopSound=function(e,t){var o=this.getSound(e);if(!o)throw new Error("No sound registered: "+e);return new u(o,t)},r.addMethods=function(e){d.inheritMethods(e,r,"getSound","start","muteAllSounds","stopResourceSounds","loopSound","traverse")},d.inherit(n,l),r.addMethods(n),n.prototype.__cleanUp=function(){r.prototype.destroy.call(this),l.prototype.__cleanUp.call(this)},n.prototype.doLoad=function(){var e={baseURL:this.getConfigVal("baseURL"),volume:this.getConfigVal("volume")},t=d.q.defer(),o=this.getConfigVal("sounds").map(s),r=d.q.all(this.getConfigVal("sounds").map(this._loadASound.bind(this,e,t,o)));return d.qlib.promise2defer(r,t),t},n.prototype.doUnload=function(){return this.sounds.traverse(this._unloadSound.bind(this)),this.sounds.purge(),p.resolve(!0)},n.prototype._unloadSound=function(e,t){e&&(e.stop(),e.unload())},n.prototype._notifyMainDefer=function(e,t,o,r){r[o]=!0;var n=r.filter(d.isVal),s={type:"howler",percent:Math.floor(100*n.length/r.length)};e.notify(s),t.resolve(!0)},n.prototype._loadASound=function(e,t,o,r,n){var s=d.q.defer(),i=d.extend({},e,r),u=new Howl({src:i.files.map(function(e,t){return e+"/"+t}.bind(null,i.baseURL)),autoplay:!1,volume:"volume"in i?i.volume:1,loop:i.loop||!1,sprite:i.sprite||void 0,preload:!0,mute:!1,onload:this._notifyMainDefer.bind(this,t,s,n,o),onloaderror:this._failed.bind(this,s,i),html5:i.html5||!1});return this.sounds.add(i.name,u),s.promise},n.prototype._failed=function(e){console.log("failed to load",arguments),console.trace(),e.reject(new Error("failed"))},n.prototype.CONFIG_SCHEMA=function(){return a},n.prototype.DEFAULT_CONFIG=function(){return null},d.inherit(i,l),r.addMethods(i),i.prototype.__cleanUp=function(){r.prototype.destroy.call(this),l.prototype.__cleanUp.call(this)},i.prototype._add_sound=function(e,t){this.sounds.add(t,e)},i.prototype._replace_sound=function(e,t){this.sounds.replace(t,e)},i.prototype.merge=function(e,t){return e&&e.traverse(this._add_sound.bind(this)),t&&t.traverse(this._replace_sound.bind(this)),p.resolve(!0)},i.prototype._resolveResource=function(e){var t=this.getConfigVal(e);return d.isString(t)?l.getResourceFromName(t):t},i.prototype.doLoad=function(){var e=this._doLoad(),t=p.defer();return d.qlib.promise2defer(e,t),t},i.prototype._doLoad=function(){var e=this._resolveResource("main_resource"),t=this._resolveResource("override_resource");return e||t?e?t?p.all([e.doLoad(),t.doLoad()]).then(this.merge.bind(this,e,t)):e.doLoad().then(this.merge.bind(this,e)):t.doLoad().then(this.merge.bind(this,null,t)):p.resolve(!0)},i.prototype.doUnload=function(){var e=this._doUnload(),t=p.defer();return d.qlib.promise2defer(e,t),t},i.prototype._doUnload=function(){this.sounds.purge();var e=this._resolveResource("main_resource"),t=this._resolveResource("override_resource");return e||t?e?t?p.all([this._resolveResource("main_resource").doUnload(),this._resolveResource("override_resource").doUnload()]):e.doUnload():t.doUnload():p.resolve(!0)},i.prototype.CONFIG_SCHEMA=function(){return h},i.prototype.DEFAULT_CONFIG=function(){return null},u.prototype.destroy=function(){this.sound=null,this.sprite=null,this._cnt=null,this._onend=null,this.reps=null,this.defer=null,this._time=null},u.prototype.stop=function(){this.defer&&this.defer.resolve(!0),this.sound.off("end",this._onend),this.sound.stop(),this.reps=0},u.prototype.start=function(e,t){return this._time=(new Date).getTime(),t||(t=d.q.defer()),this.reps=d.isNumber(e)&&e>0?e:null,this.defer=t,this.sound.on("end",this._onend),this._onEnd(),t.promise},u.prototype._onEnd=function(){this._time;if(this._time=(new Date).getTime(),d.isNull(this.reps))this.defer&&this.defer.notify({remaining:1/0});else{if(!this.reps)return void this.stop();this.defer&&this.defer.notify({remaining:this.reps}),this.reps--}this.sound&&this.sound.play(this.sprite)},t.resources.HowlerResource=n,o.registerResourceType("Howler",n),o.registerResourceType("HowlerMerger",i)}(ALLEX,ALLEX.WEB_COMPONENTS.allex_web_webappcomponent,ALLEX.WEB_COMPONENTS.allex_applib);