!function(a,b,c){"use strict";function d(){this.sounds=new k.Map}function e(a,b){return a.off("stop",b),a.off("end",b),k.q.resolve(!0)}function f(a){l.call(this,a),d.call(this)}function g(){return null}function h(a,b){return a+"/"+b}function i(a){l.call(this,a),d.call(this)}function j(a,b){if(b&&!k.isString(b))throw new Error("Unable to play sound sprites upon something that is not a string: "+b);this.sound=a,this.sprite=b||void 0,this._cnt=null,this._onend=this._onEnd.bind(this),this.reps=0,this.defer=null,this._time=null}var k=a.lib,l=c.BasicResourceLoader,m=(c.getResource,k.q),n={type:"object",properties:{sounds:{type:"array",items:{type:"object",properties:{name:{type:"string"},baseURL:{type:"string"},files:{type:"array",items:{type:"string"},volume:{type:"number",min:0,max:1},minItems:1},sprite:{type:"object"}},required:["files","name"]},minItems:1},baseURL:{type:"string"},volume:{type:"number"},ispermanent:{type:"boolean"}},additionalProperties:!1},o={type:"object",properties:{main_resource:{type:"string"},override_resource:{type:"string"}}};d.prototype.destroy=function(){this.sounds.destroy(),this.sounds=null},d.prototype.traverse=function(a){this.sounds.traverse(a)},d.prototype.getSound=function(a){return this.sounds.get(a)},d.prototype.start=function(a,b,c){var d=this.getSound(a),f=k.q.defer(),g=f.resolve.bind(f,!0);return d?(d.stop(),d.on("stop",g),d.on("end",g),console.log("will play ",a,b,c),d.play(c),f.promise.then(e.bind(null,d,g))):b?f.resolve(!0):f.reject(new Error("No sound "+a))},d.prototype.muteAllSounds=Howler.mute.bind(Howler),d.prototype.stopResourceSounds=function(){this.sounds.traverse(k.doMethod.bind(null,"stop",null))},d.prototype.loopSound=function(a,b){var c=this.getSound(a);if(!c)throw new Error("No sound registered: "+a);return new j(c,b)},d.addMethods=function(a){k.inheritMethods(a,d,"getSound","start","muteAllSounds","stopResourceSounds","loopSound","traverse")},k.inherit(f,l),d.addMethods(f),f.prototype.__cleanUp=function(){d.prototype.destroy.call(this),l.prototype.__cleanUp.call(this)},f.prototype.doLoad=function(){var a={baseURL:this.getConfigVal("baseURL"),volume:this.getConfigVal("volume")},b=k.q.defer(),c=this.getConfigVal("sounds").map(g),d=k.q.all(this.getConfigVal("sounds").map(this._loadASound.bind(this,a,b,c)));return k.qlib.promise2defer(d,b),b},f.prototype.doUnload=function(){return this.sounds.traverse(this._unloadSound.bind(this)),this.sounds.purge(),m.resolve(!0)},f.prototype._unloadSound=function(a,b){a&&(a.stop(),a.unload())},f.prototype._notifyMainDefer=function(a,b,c,d){d[c]=!0;var e=d.filter(k.isVal),f={type:"howler",percent:Math.floor(100*e.length/d.length)};a.notify(f),b.resolve(!0)},f.prototype._loadASound=function(a,b,c,d,e){var f=k.q.defer(),g=k.extend({},a,d),i=new Howl({src:g.files.map(h.bind(null,g.baseURL)),autoplay:!1,volume:"volume"in g?g.volume:1,loop:g.loop||!1,sprite:g.sprite||void 0,preload:!0,mute:!1,onload:this._notifyMainDefer.bind(this,b,f,e,c),onloaderror:this._failed.bind(this,f,g),html5:g.html5||!1});return this.sounds.add(g.name,i),f.promise},f.prototype._failed=function(a){console.log("failed to load",arguments),console.trace(),a.reject(new Error("failed"))},f.prototype.CONFIG_SCHEMA=function(){return n},f.prototype.DEFAULT_CONFIG=function(){return null},k.inherit(i,l),d.addMethods(i),i.prototype.__cleanUp=function(){d.prototype.destroy.call(this),l.prototype.__cleanUp.call(this)},i.prototype._add_sound=function(a,b){this.sounds.add(b,a)},i.prototype._replace_sound=function(a,b){this.sounds.replace(b,a)},i.prototype.merge=function(a,b){return a&&a.traverse(this._add_sound.bind(this)),b&&b.traverse(this._replace_sound.bind(this)),m.resolve(!0)},i.prototype._resolveResource=function(a){var b=this.getConfigVal(a);return k.isString(b)?l.getResourceFromName(b):b},i.prototype.doLoad=function(){var a=this._doLoad(),b=m.defer();return k.qlib.promise2defer(a,b),b},i.prototype._doLoad=function(){var a=this._resolveResource("main_resource"),b=this._resolveResource("override_resource");return a||b?a?b?m.all([a.doLoad(),b.doLoad()]).then(this.merge.bind(this,a,b)):a.doLoad().then(this.merge.bind(this,a)):b.doLoad().then(this.merge.bind(this,null,b)):m.resolve(!0)},i.prototype.doUnload=function(){var a=this._doUnload(),b=m.defer();return k.qlib.promise2defer(a,b),b},i.prototype._doUnload=function(){this.sounds.purge();var a=this._resolveResource("main_resource"),b=this._resolveResource("override_resource");return a||b?a?b?m.all([this._resolveResource("main_resource").doUnload(),this._resolveResource("override_resource").doUnload()]):a.doUnload():b.doUnload():m.resolve(!0)},i.prototype.CONFIG_SCHEMA=function(){return o},i.prototype.DEFAULT_CONFIG=function(){return null},j.prototype.destroy=function(){this.sound=null,this.sprite=null,this._cnt=null,this._onend=null,this.reps=null,this.defer=null,this._time=null},j.prototype.stop=function(){this.defer&&this.defer.resolve(!0),this.sound.off("end",this._onend),this.sound.stop(),this.reps=0},j.prototype.start=function(a,b){return this._time=(new Date).getTime(),b||(b=k.q.defer()),this.reps=k.isNumber(a)&&a>0?a:null,this.defer=b,this.sound.on("end",this._onend),this._onEnd(),b.promise},j.prototype._onEnd=function(){this._time;if(this._time=(new Date).getTime(),k.isNull(this.reps))this.defer.notify({remaining:1/0});else{if(!this.reps)return void this.stop();this.defer.notify({remaining:this.reps}),this.reps--}this.sound.play(this.sprite)},b.resources.HowlerResource=f,c.registerResourceType("Howler",f),c.registerResourceType("HowlerMerger",i)}(ALLEX,ALLEX.WEB_COMPONENTS.allex_web_webappcomponent,ALLEX.WEB_COMPONENTS.allex_applib);