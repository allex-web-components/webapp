!function(e,t,o){"use strict";var r=e.lib,n=o.BasicResourceLoader,s=(o.getResource,r.q),i={type:"object",properties:{sounds:{type:"array",items:{type:"object",properties:{name:{type:"string"},baseURL:{type:"string"},files:{type:"array",items:{type:"string"},volume:{type:"number",min:0,max:1},minItems:1},sprite:{type:"object"}},required:["files","name"]},minItems:1},baseURL:{type:"string"},volume:{type:"number"},ispermanent:{type:"boolean"}},additionalProperties:!1},u={type:"object",properties:{main_resource:{type:"string"},override_resource:{type:"string"}}};function d(){this.sounds=new r.Map}function l(e){n.call(this,e),d.call(this)}function p(){return null}function a(e){n.call(this,e),d.call(this)}function h(e,t){if(t&&!r.isString(t))throw new Error("Unable to play sound sprites upon something that is not a string: "+t);this.sound=e,this.sprite=t||void 0,this._cnt=null,this._onend=this._onEnd.bind(this),this.reps=0,this.defer=null,this._time=null}d.prototype.destroy=function(){this.sounds.destroy(),this.sounds=null},d.prototype.traverse=function(e){this.sounds.traverse(e)},d.prototype.getSound=function(e){return this.sounds.get(e)},d.prototype.start=function(e,t,o){var n=this.getSound(e),s=r.q.defer(),i=s.resolve.bind(s,!0);return n?(n.stop(),n.on("stop",i),n.on("end",i),console.log("will play ",e,t,o),n.play(o),s.promise.then(function(e,t){return e.off("stop",t),e.off("end",t),r.q.resolve(!0)}.bind(null,n,i))):t?s.resolve(!0):s.reject(new Error("No sound "+e))},d.prototype.muteAllSounds=Howler.mute.bind(Howler),d.prototype.stopResourceSounds=function(){this.sounds.traverse(r.doMethod.bind(null,"stop",null))},d.prototype.loopSound=function(e,t){var o=this.getSound(e);if(!o)throw new Error("No sound registered: "+e);return new h(o,t)},d.addMethods=function(e){r.inheritMethods(e,d,"getSound","start","muteAllSounds","stopResourceSounds","loopSound","traverse")},r.inherit(l,n),d.addMethods(l),l.prototype.__cleanUp=function(){d.prototype.destroy.call(this),n.prototype.__cleanUp.call(this)},l.prototype.doLoad=function(){var e={baseURL:this.getConfigVal("baseURL"),volume:this.getConfigVal("volume")},t=r.q.defer(),o=this.getConfigVal("sounds").map(p),n=r.q.all(this.getConfigVal("sounds").map(this._loadASound.bind(this,e,t,o)));return r.qlib.promise2defer(n,t),t},l.prototype.doUnload=function(){return this.sounds.traverse(this._unloadSound.bind(this)),this.sounds.purge(),s.resolve(!0)},l.prototype._unloadSound=function(e,t){e&&(e.stop(),e.unload())},l.prototype._notifyMainDefer=function(e,t,o,n){n[o]=!0;var s=n.filter(r.isVal),i={type:"howler",percent:Math.floor(100*s.length/n.length)};e.notify(i),t.resolve(!0)},l.prototype._loadASound=function(e,t,o,n,s){var i=r.q.defer(),u=r.extend({},e,n),d=new Howl({src:u.files.map(function(e,t){return e+"/"+t}.bind(null,u.baseURL)),autoplay:!1,volume:"volume"in u?u.volume:1,loop:u.loop||!1,sprite:u.sprite||void 0,preload:!0,mute:!1,onload:this._notifyMainDefer.bind(this,t,i,s,o),onloaderror:this._failed.bind(this,i,u),html5:u.html5||!1});return this.sounds.add(u.name,d),i.promise},l.prototype._failed=function(e){console.log("failed to load",arguments),console.trace(),e.reject(new Error("failed"))},l.prototype.CONFIG_SCHEMA=function(){return i},l.prototype.DEFAULT_CONFIG=function(){return null},r.inherit(a,n),d.addMethods(a),a.prototype.__cleanUp=function(){d.prototype.destroy.call(this),n.prototype.__cleanUp.call(this)},a.prototype._add_sound=function(e,t){this.sounds.add(t,e)},a.prototype._replace_sound=function(e,t){this.sounds.replace(t,e)},a.prototype.merge=function(e,t){return e&&e.traverse(this._add_sound.bind(this)),t&&t.traverse(this._replace_sound.bind(this)),s.resolve(!0)},a.prototype._resolveResource=function(e){var t=this.getConfigVal(e);return r.isString(t)?n.getResourceFromName(t):t},a.prototype.doLoad=function(){var e=this._doLoad(),t=s.defer();return r.qlib.promise2defer(e,t),t},a.prototype._doLoad=function(){var e=this._resolveResource("main_resource"),t=this._resolveResource("override_resource");return e||t?e?t?s.all([e.doLoad(),t.doLoad()]).then(this.merge.bind(this,e,t)):e.doLoad().then(this.merge.bind(this,e)):t.doLoad().then(this.merge.bind(this,null,t)):s.resolve(!0)},a.prototype.doUnload=function(){var e=this._doUnload(),t=s.defer();return r.qlib.promise2defer(e,t),t},a.prototype._doUnload=function(){this.sounds.purge();var e=this._resolveResource("main_resource"),t=this._resolveResource("override_resource");return e||t?e?t?s.all([this._resolveResource("main_resource").doUnload(),this._resolveResource("override_resource").doUnload()]):e.doUnload():t.doUnload():s.resolve(!0)},a.prototype.CONFIG_SCHEMA=function(){return u},a.prototype.DEFAULT_CONFIG=function(){return null},h.prototype.destroy=function(){this.sound=null,this.sprite=null,this._cnt=null,this._onend=null,this.reps=null,this.defer=null,this._time=null},h.prototype.stop=function(){this.defer&&this.defer.resolve(!0),this.sound.off("end",this._onend),this.sound.stop(),this.reps=0},h.prototype.start=function(e,t){return this._time=(new Date).getTime(),t||(t=r.q.defer()),this.reps=r.isNumber(e)&&e>0?e:null,this.defer=t,this.sound.on("end",this._onend),this._onEnd(),t.promise},h.prototype._onEnd=function(){this._time;if(this._time=(new Date).getTime(),r.isNull(this.reps))this.defer&&this.defer.notify({remaining:1/0});else{if(!this.reps)return void this.stop();this.defer&&this.defer.notify({remaining:this.reps}),this.reps--}this.sound&&this.sound.play(this.sprite)},t.resources.HowlerResource=l,o.registerResourceType("Howler",l),o.registerResourceType("HowlerMerger",a)}(ALLEX,ALLEX.WEB_COMPONENTS.allex_web_webappcomponent,ALLEX.WEB_COMPONENTS.allex_applib);