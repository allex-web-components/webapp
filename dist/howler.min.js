!function(a,b,c){"use strict";function d(a){i.call(this,a),this.sounds=new h.Map}function e(a,b){return a+"/"+b}function f(a,b){return a.off("stop",b),a.off("end",b),h.q.resolve(!0)}function g(a,b){if(b&&!h.isString(b))throw new Error("Unable to play sound sprites upon something that is not a string: "+b);this.sound=a,this.sprite=b||void 0,this._cnt=null,this._onend=this._onEnd.bind(this),this.reps=0,this.defer=null,this._time=null}var h=a.lib,i=c.BasicResourceLoader,j={type:"object",properties:{sounds:{type:"array",items:{type:"object",properties:{name:{type:"string"},baseURL:{type:"string"},files:{type:"array",items:{type:"string"},volume:{type:"number",min:0,max:1},minItems:1},sprite:{type:"object"}},required:["files","name"]},minItems:1},baseURL:{type:"string"},volume:{type:"number"},ispermanent:{type:"boolean"}},additionalProperties:!1};h.inherit(d,i),d.prototype.__cleanUp=function(){this.sounds.destroy(),this.sounds=null,i.prototype.__cleanUp.call(this)},d.prototype.doLoad=function(){var a={baseURL:this.getConfigVal("baseURL"),volume:this.getConfigVal("volume")},b=h.q.all(this.getConfigVal("sounds").map(this._loadASound.bind(this,a)));b.done(console.log.bind(console,"done"),console.log.bind(console,"failed"));var c=h.q.defer();return h.qlib.promise2defer(b,c),c},d.prototype._loadASound=function(a,b){var c=h.q.defer(),d=h.extend({},a,b),f=new Howl({src:d.files.map(e.bind(null,d.baseURL)),autoplay:!1,volume:"volume"in d?d.volume:1,loop:d.loop||!1,sprite:d.sprite||void 0,preload:!0,mute:!1,onload:c.resolve.bind(c,!0),onloaderror:this._failed.bind(this,c),html5:!!h.isUndef(d.html5)||d.html5});return this.sounds.add(d.name,f),c.promise},d.prototype._failed=function(a){console.log("failed to load",arguments),a.reject(new Error("failed"))},d.prototype.getSound=function(a){return this.sounds.get(a)},d.prototype.start=function(a,b,c){var d=this.getSound(a);if(!d)return b?e.resolve(!0):e.reject(new Error("No sound "+a));var e=h.q.defer(),g=e.resolve.bind(e,!0);return d.on("stop",g),d.on("end",g),d.play(c),e.promise.then(f.bind(null,d,g))},d.prototype.muteAllSounds=Howler.mute.bind(Howler),d.prototype.stopResourceSounds=function(){this.sounds.traverse(h.doMethod.bind(null,"stop",null))},d.prototype.CONFIG_SCHEMA=function(){return j},d.prototype.DEFAULT_CONFIG=function(){return null},d.prototype.loopSound=function(a,b){var c=this.getSound(a);if(!c)throw new Error("No sound registered: "+a);return new g(c,b)},g.prototype.destroy=function(){this.sound=null,this.sprite=null,this._cnt=null,this._onend=null,this.reps=null,this.defer=null,this._time=null},g.prototype.stop=function(){this.defer&&this.defer.resolve(!0),this.sound.off("end",this._onend),this.sound.stop(),this.reps=0},g.prototype.start=function(a,b){return this._time=(new Date).getTime(),b||(b=h.q.defer()),this.reps=h.isNumber(a)&&a>0?a:null,this.defer=b,this.sound.on("end",this._onend),this._onEnd(),b.promise},g.prototype._onEnd=function(){this._time;if(this._time=(new Date).getTime(),h.isNull(this.reps))this.defer.notify({remaining:1/0});else{if(!this.reps)return void this.stop();this.defer.notify({remaining:this.reps}),this.reps--}this.sound.play(this.sprite)},b.resources.HowlerResource=d,c.registerResourceType("Howler",d)}(ALLEX,ALLEX.WEB_COMPONENTS.allex_web_webappcomponent,ALLEX.WEB_COMPONENTS.allex_applib);