!function(a,b,c){"use strict";function d(){this.sounds=new j.Map}function e(a,b){return a.off("stop",b),a.off("end",b),j.q.resolve(!0)}function f(a){k.call(this,a),d.call(this)}function g(a,b){return a+"/"+b}function h(a){k.call(this,a),d.call(this)}function i(a,b){if(b&&!j.isString(b))throw new Error("Unable to play sound sprites upon something that is not a string: "+b);this.sound=a,this.sprite=b||void 0,this._cnt=null,this._onend=this._onEnd.bind(this),this.reps=0,this.defer=null,this._time=null}var j=a.lib,k=c.BasicResourceLoader,l=(c.getResource,j.q),m={type:"object",properties:{sounds:{type:"array",items:{type:"object",properties:{name:{type:"string"},baseURL:{type:"string"},files:{type:"array",items:{type:"string"},volume:{type:"number",min:0,max:1},minItems:1},sprite:{type:"object"}},required:["files","name"]},minItems:1},baseURL:{type:"string"},volume:{type:"number"},ispermanent:{type:"boolean"}},additionalProperties:!1},n={type:"object",properties:{main_resource:{type:"string"},override_resource:{type:"string"}}};d.prototype.destroy=function(){this.sounds.destroy(),this.sounds=null},d.prototype.traverse=function(a){this.sounds.traverse(a)},d.prototype.getSound=function(a){return this.sounds.get(a)},d.prototype.start=function(a,b,c){var d=this.getSound(a);if(!d)return b?f.resolve(!0):f.reject(new Error("No sound "+a));var f=j.q.defer(),g=f.resolve.bind(f,!0);return d.on("stop",g),d.on("end",g),d.play(c),f.promise.then(e.bind(null,d,g))},d.prototype.muteAllSounds=Howler.mute.bind(Howler),d.prototype.stopResourceSounds=function(){this.sounds.traverse(j.doMethod.bind(null,"stop",null))},d.prototype.loopSound=function(a,b){var c=this.getSound(a);if(!c)throw new Error("No sound registered: "+a);return new i(c,b)},d.addMethods=function(a){j.inheritMethods(a,d,"getSound","start","muteAllSounds","stopResourceSounds","loopSound","traverse")},j.inherit(f,k),d.addMethods(f),f.prototype.__cleanUp=function(){d.prototype.destroy.call(this),k.prototype.__cleanUp.call(this)},f.prototype.doLoad=function(){var a={baseURL:this.getConfigVal("baseURL"),volume:this.getConfigVal("volume")},b=j.q.all(this.getConfigVal("sounds").map(this._loadASound.bind(this,a)));b.done(console.log.bind(console,"done"),console.log.bind(console,"failed"));var c=j.q.defer();return j.qlib.promise2defer(b,c),c},f.prototype._loadASound=function(a,b){var c=j.q.defer(),d=j.extend({},a,b),e=new Howl({src:d.files.map(g.bind(null,d.baseURL)),autoplay:!1,volume:"volume"in d?d.volume:1,loop:d.loop||!1,sprite:d.sprite||void 0,preload:!0,mute:!1,onload:c.resolve.bind(c,!0),onloaderror:this._failed.bind(this,c),html5:!!j.isUndef(d.html5)||d.html5});return this.sounds.add(d.name,e),c.promise},f.prototype._failed=function(a){console.log("failed to load",arguments),a.reject(new Error("failed"))},f.prototype.CONFIG_SCHEMA=function(){return m},f.prototype.DEFAULT_CONFIG=function(){return null},j.inherit(h,k),d.addMethods(h),h.prototype.__cleanUp=function(){d.prototype.destroy.call(this),k.prototype.__cleanUp.call(this)},h.prototype._add_sound=function(a,b){this.sounds.add(b,a)},h.prototype._replace_sound=function(a,b){this.sounds.replace(b,a)},h.prototype.merge=function(a,b){return a&&a.traverse(this._add_sound.bind(this)),b&&b.traverse(this._replace_sound.bind(this)),l.resolve(!0)},h.prototype._resolveResource=function(a){var b=this.getConfigVal(a);return j.isString(b)?k.getResourceFromName(b):b},h.prototype.doLoad=function(){var a=this._doLoad(),b=l.defer();return j.qlib.promise2defer(a,b),b},h.prototype._doLoad=function(){var a=this._resolveResource("main_resource"),b=this._resolveResource("override_resource");return a||b?a?b?l.all([a.doLoad(),b.doLoad()]).then(this.merge.bind(this,a,b)):a.doLoad().then(this.merge.bind(this,a)):b.doLoad().then(this.merge.bind(this,null,b)):l.resolve(!0)},h.prototype.doUnload=function(){var a=this._doUnload(),b=l.defer();return j.qlib.promise2defer(a,b),b},h.prototype._doUnload=function(){this.sounds.purge();var a=this._resolveResource("main_resource"),b=this._resolveResource("override_resource");return a||b?a?b?l.all([this._resolveResource("main_resource").doUnload(),this._resolveResource("override_resource").doUnload()]):a.doUnload():b.doUnload():l.resolve(!0)},h.prototype.CONFIG_SCHEMA=function(){return n},h.prototype.DEFAULT_CONFIG=function(){return null},i.prototype.destroy=function(){this.sound=null,this.sprite=null,this._cnt=null,this._onend=null,this.reps=null,this.defer=null,this._time=null},i.prototype.stop=function(){this.defer&&this.defer.resolve(!0),this.sound.off("end",this._onend),this.sound.stop(),this.reps=0},i.prototype.start=function(a,b){return this._time=(new Date).getTime(),b||(b=j.q.defer()),this.reps=j.isNumber(a)&&a>0?a:null,this.defer=b,this.sound.on("end",this._onend),this._onEnd(),b.promise},i.prototype._onEnd=function(){this._time;if(this._time=(new Date).getTime(),j.isNull(this.reps))this.defer.notify({remaining:1/0});else{if(!this.reps)return void this.stop();this.defer.notify({remaining:this.reps}),this.reps--}this.sound.play(this.sprite)},b.resources.HowlerResource=f,c.registerResourceType("Howler",f),c.registerResourceType("HowlerMerger",h)}(ALLEX,ALLEX.WEB_COMPONENTS.allex_web_webappcomponent,ALLEX.WEB_COMPONENTS.allex_applib);